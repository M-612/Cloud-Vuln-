import pandas as pd
from sklearn.preprocessing import LabelEncoder
from sklearn.feature_extraction.text import TfidfVectorizer
from imblearn.over_sampling import SMOTE


def preprocess_data(csv_path):
    df = pd.read_csv(csv_path)
    df["summary"] = df["summary"].fillna("")
    df["severity"] = pd.cut(
        df["cvss"], bins=[0, 4, 7, 9, 10], labels=["Low", "Medium", "High", "Critical"]
    )
    df["text_features"] = df["summary"] + " " + df["cwe_name"].fillna("")
    label_encoder = LabelEncoder()
    df["vuln_type"] = label_encoder.fit_transform(df["cwe_name"].fillna("Unknown"))
    return df, label_encoder


def vectorize_features(df):
    tfidf = TfidfVectorizer(max_features=5000, stop_words="english")
    X = tfidf.fit_transform(df["text_features"])
    y = df["vuln_type"]
    return X, y, tfidf, df["vuln_type"]
