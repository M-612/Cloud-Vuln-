<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Results - Vulnerability Scanner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
</head>
<body>
    <header>
        <h1><i class="fas fa-shield-alt"></i> Vulnerability Scanner</h1>
        <nav>
            <a href="{{ url_for('index') }}" class="btn"><i class="fas fa-home"></i> Dashboard</a>
        </nav>
    </header>
    
    <main class="results-container">
        <section class="scan-info">
            <h2>Scan Results</h2>
            <div class="scan-details">
                <div class="detail-item">
                    <span class="label">URL:</span>
                    <span class="value">{{ results.url }}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Scan Date:</span>
                    <span class="value">{{ results.scan_date }}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Scan ID:</span>
                    <span class="value">{{ results.scan_id }}</span>
                </div>
            </div>
            
            <div class="action-buttons">
                <a href="{{ url_for('generate_report', scan_id=results.scan_id) }}" class="btn primary">
                    <i class="fas fa-file-pdf"></i> Generate PDF Report
                </a>
                <a href="{{ url_for('index') }}" class="btn">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </section>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert {{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <section class="vulnerability-summary">
            <h3>Vulnerability Summary</h3>
            
            <div class="summary-container">
                <div class="chart-container">
                    <canvas id="vulnerabilityChart"></canvas>
                </div>
                
                <div class="severity-counts">
                    {% set severity_classes = {
                        'Critical': 'critical',
                        'High': 'high',
                        'Medium': 'medium',
                        'Low': 'low',
                        'None': 'info'
                    } %}
                    
                    {% for severity, vulns in results.vulnerabilities.items() %}
                        <div class="severity-item {{ severity_classes[severity] }}">
                            <div class="severity-label">{{ severity }}</div>
                            <div class="severity-count">{{ vulns|length }}</div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </section>
        
        <section class="vulnerability-details">
            <h3>Detailed Findings</h3>
            
            <div class="tabs">
                <div class="tab-headers">
                    {% set first_tab = true %}
                    {% for severity in ['Critical', 'High', 'Medium', 'Low', 'None'] %}
                        {% if results.vulnerabilities[severity]|length > 0 %}
                            <button class="tab-btn {% if first_tab %}active{% endif %}" data-tab="{{ severity }}">
                                {{ severity }} ({{ results.vulnerabilities[severity]|length }})
                            </button>
                            {% if first_tab %}
                                {% set first_tab = false %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
                
                <div class="tab-contents">
                    {% set first_content = true %}
                    {% for severity in ['Critical', 'High', 'Medium', 'Low', 'None'] %}
                        {% if results.vulnerabilities[severity]|length > 0 %}
                            <div class="tab-content {% if first_content %}active{% endif %}" id="{{ severity }}-tab">
                                {% for vuln in results.vulnerabilities[severity] %}
                                    <div class="vulnerability-card">
                                        <div class="vuln-header">
                                            <h4 class="vuln-title">{{ vuln.type }}</h4>
                                            <span class="vuln-score">
                                                CVSS: {{ "%.1f"|format(vuln.cvss_score) }}
                                            </span>
                                        </div>
                                        
                                        <div class="vuln-content">
                                            <div class="vuln-field">
                                                <span class="field-label">Description:</span>
                                                <span class="field-value">{{ vuln.description }}</span>
                                            </div>
                                            
                                            {% if vuln.url %}
                                            <div class="vuln-field">
                                                <span class="field-label">URL:</span>
                                                <span class="field-value">{{ vuln.url }}</span>
                                            </div>
                                            {% endif %}
                                            
                                            <div class="vuln-field">
                                                <span class="field-label">Detection Tool:</span>
                                                <span class="field-value">{{ vuln.tool }}</span>
                                            </div>
                                            
                                            <div class="vuln-field">
                                                <span class="field-label">Remediation:</span>
                                                <span class="field-value">{{ vuln.remediation }}</span>
                                            </div>
                                            
                                            {% if vuln.details and vuln.details is mapping %}
                                            <div class="vuln-field">
                                                <button class="toggle-details" data-target="details-{{ loop.index }}">
                                                    <i class="fas fa-plus"></i> Show Technical Details
                                                </button>
                                                <div class="details-container hidden" id="details-{{ loop.index }}">
                                                    <pre>{{ vuln.details|tojson(indent=2) }}</pre>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if first_content %}
                                {% set first_content = false %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </section>
    </main>
    
    <footer>
        <p>&copy; {{ current_year }} Vulnerability Scanner | <i class="fas fa-shield-alt"></i> Security Tool</p>
    </footer>
    
    <script>
        // Chart setup
        const setupChart = () => {
            const ctx = document.getElementById('vulnerabilityChart').getContext('2d');
            
            const severities = {
                'Critical': {{ results.vulnerabilities.Critical|length or 0 }},
                'High': {{ results.vulnerabilities.High|length or 0 }},
                'Medium': {{ results.vulnerabilities.Medium|length or 0 }},
                'Low': {{ results.vulnerabilities.Low|length or 0 }},
                'None': {{ results.vulnerabilities.None|length or 0 }}
            };
            
            const severityColors = {
                'Critical': '#d9534f',
                'High': '#f0ad4e',
                'Medium': '#ffc107',
                'Low': '#5bc0de',
                'None': '#5cb85c'
            };
            
            const data = {
                labels: Object.keys(severities),
                datasets: [{
                    data: Object.values(severities),
                    backgroundColor: Object.keys(severities).map(sev => severityColors[sev]),
                    borderWidth: 1
                }]
            };
            
            const options = {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    title: {
                        display: true,
                        text: 'Vulnerabilities by Severity'
                    }
                }
            };
            
            new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: options
            });
        };
        
        // Tab switching
        const setupTabs = () => {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        };
        
        // Toggle technical details
        const setupDetailsToggles = () => {
            const toggleButtons = document.querySelectorAll('.toggle-details');
            
            toggleButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.getAttribute('data-target');
                    const targetElement = document.getElementById(targetId);
                    
                    if (targetElement.classList.contains('hidden')) {
                        targetElement.classList.remove('hidden');
                        button.innerHTML = '<i class="fas fa-minus"></i> Hide Technical Details';
                    } else {
                        targetElement.classList.add('hidden');
                        button.innerHTML = '<i class="fas fa-plus"></i> Show Technical Details';
                    }
                });
            });
        };
        
        // Initialize everything when the DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            setupChart();
            setupTabs();
            setupDetailsToggles();
            
            // Auto-hide flash messages after 5 seconds
            const flashMessages = document.querySelectorAll('.alert');
            if (flashMessages.length) {
                setTimeout(() => {
                    flashMessages.forEach(message => {
                        message.style.opacity = '0';
                        setTimeout(() => message.remove(), 500);
                    });
                }, 5000);
            }
        });
    </script>
</body>
</html>