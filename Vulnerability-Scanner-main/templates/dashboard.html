<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vulnerability Scanner Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
</head>
<body>
    <header>
        <div class="logo">
            <i class="fas fa-shield-alt"></i>
            <h1>Vulnerability Scanner</h1>
        </div>
        <nav>
            <ul>
                <li><a href="#" class="active">Dashboard</a></li>
                <li><a href="#scan-section">Scan</a></li>
                <li><a href="#history-section">History</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-search"></i>
                </div>
                <div class="stat-info">
                    <h3>Total Scans</h3>
                    <p>{{ scans|length }}</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-info">
                    <h3>Vulnerabilities Found</h3>
                    <p id="total-vulns">Calculating...</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-skull-crossbones"></i>
                </div>
                <div class="stat-info">
                    <h3>Critical Vulnerabilities</h3>
                    <p id="critical-vulns">Calculating...</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h3>Completed Scans</h3>
                    <p id="completed-scans">Calculating...</p>
                </div>
            </div>
        </section>

        <section id="scan-section" class="scan-section">
            <div class="section-header">
                <h2>Start New Scan</h2>
            </div>
            <div class="scan-form">
                <form action="/scan" method="post">
                    <div class="form-group">
                        <label for="url">Target URL:</label>
                        <input type="text" id="url" name="url" placeholder="https://example.com" required>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn primary">Start Scan</button>
                    </div>
                </form>
            </div>
        </section>

        <section id="history-section" class="history-section">
            <div class="section-header">
                <h2>Scan History</h2>
            </div>
            <div class="scan-history">
                <table>
                    <thead>
                        <tr>
                            <th>URL</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for scan in scans %}
                        <tr data-scan-id="{{ scan.scan_id }}">
                            <td>{{ scan.url }}</td>
                            <td>{{ scan.scan_date }}</td>
                            <td class="scan-status">
                                {% if scan.status == 'in_progress' %}
                                <span class="status in-progress">In Progress</span>
                                {% elif scan.status == 'completed' %}
                                <span class="status completed">Completed</span>
                                {% elif scan.status == 'failed' %}
                                <span class="status failed">Failed</span>
                                {% endif %}
                            </td>
                            <td class="action-buttons">
                                {% if scan.status == 'completed' %}
                                <a href="{{ url_for('results', scan_id=scan.scan_id) }}" class="btn view-btn">View</a>
                                <a href="{{ url_for('generate_report', scan_id=scan.scan_id) }}" class="btn report-btn">Report</a>
                                {% elif scan.status == 'in_progress' %}
                                <button class="btn view-btn" disabled>View</button>
                                <button class="btn report-btn" disabled >Report</button>
                                {% endif %}
                                <form method="post" action="{{ url_for('delete_scan', scan_id=scan.scan_id) }}" onsubmit="return confirm('Are you sure you want to delete this scan?');">
                                    <button type="submit" class="btn delete-btn">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <footer>
        <p>&copy; 2025 Vulnerability Scanner</p>
    </footer>

    <script>
        // Update scan status automatically
        document.addEventListener('DOMContentLoaded', function() {
            // Count statistics
            let totalVulns = 0;
            let criticalVulns = 0;
            let completedScans = 0;
            
            // Update scan status for in-progress scans
            const scanRows = document.querySelectorAll('tr[data-scan-id]');
            scanRows.forEach(row => {
                const scanId = row.getAttribute('data-scan-id');
                const statusCell = row.querySelector('.scan-status');
                
                if (statusCell.textContent.trim().includes('In Progress')) {
                    checkScanStatus(scanId, statusCell, row);
                    // Set interval to check status every 5 seconds
                    setInterval(() => checkScanStatus(scanId, statusCell, row), 5000);
                }
                
                if (statusCell.textContent.trim().includes('Completed')) {
                    completedScans++;
                }
            });
            
            // Update stats counters
            document.getElementById('completed-scans').textContent = completedScans;
            
            // Function to check scan status
            function checkScanStatus(scanId, statusCell, row) {
                fetch(`/scan_status/${scanId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'completed') {
                            statusCell.innerHTML = '<span class="status completed">Completed</span>';
                            
                            // Enable buttons
                            const actionButtons = row.querySelector('.action-buttons');
                            actionButtons.innerHTML = `
                                <a href="/results/${scanId}" class="btn view-btn">View</a>
                                <a href="/generate_report/${scanId}" class="btn report-btn">Report</a>
                                <form method="post" action="/delete_scan/${scanId}" onsubmit="return confirm('Are you sure you want to delete this scan?');">
                                    <button type="submit" class="btn delete-btn">Delete</button>
                                </form>
                            `;
                            
                            // Update completed scans count
                            completedScans++;
                            document.getElementById('completed-scans').textContent = completedScans;
                        } else if (data.status === 'failed') {
                            statusCell.innerHTML = '<span class="status failed">Failed</span>';
                        }
                    })
                    .catch(error => console.error('Error checking scan status:', error));
            }
            
            // Display chart data if we have completed scans
            if (completedScans > 0) {
                // Sample data for charts (in a real application this would come from the backend)
                const severityData = {
                    labels: ['Critical', 'High', 'Medium', 'Low', 'None'],
                    datasets: [{
                        label: 'Vulnerabilities by Severity',
                        data: [5, 12, 25, 18, 8],
                        backgroundColor: [
                            '#d32f2f', // Critical
                            '#f57c00', // High
                            '#ffeb3b', // Medium
                            '#4caf50', // Low
                            '#9e9e9e'  // None
                        ]
                    }]
                };
                
                const toolsData = {
                    labels: ['SQLMap', 'OWASP ZAP', 'Nikto', 'Nessus'],
                    datasets: [{
                        label: 'Vulnerabilities by Tool',
                        data: [15, 22, 18, 12],
                        backgroundColor: [
                            '#3f51b5',
                            '#009688',
                            '#673ab7',
                            '#607d8b'
                        ]
                    }]
                };
                
                // Create severity chart
                const severityCtx = document.getElementById('severityChart').getContext('2d');
                new Chart(severityCtx, {
                    type: 'pie',
                    data: severityData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Vulnerabilities by Severity'
                            }
                        }
                    }
                });
                
                // Create tools chart
                const toolsCtx = document.getElementById('toolsChart').getContext('2d');
                new Chart(toolsCtx, {
                    type: 'bar',
                    data: toolsData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Vulnerabilities by Tool'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                // Update counters
                document.getElementById('total-vulns').textContent = '68';
                document.getElementById('critical-vulns').textContent = '5';
            } else {
                // No data yet
                document.getElementById('total-vulns').textContent = '0';
                document.getElementById('critical-vulns').textContent = '0';
            }
        });
    </script>
</body>
</html>