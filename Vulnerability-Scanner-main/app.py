import os
import pprint
import uuid
from datetime import datetime
from flask import (
    Flask,
    render_template,
    request,
    redirect,
    url_for,
    flash,
    jsonify,
    send_from_directory,
)
from dotenv import load_dotenv
from scanner.scanner import (
    scan_url,
    get_scan_results,
    init_db,
    get_all_scans,
    add_scan,
)
from report.generate_report import generate_pdf_report

# Load .env file
load_dotenv()

app = Flask(__name__)
app.secret_key = os.environ.get("SECRET_KEY", os.urandom(24))

# Ensure directories exist
os.makedirs("db", exist_ok=True)
os.makedirs("reports", exist_ok=True)

# Initialize database (if SQLite local dev)
init_db()


@app.route("/")
def index():
    scans = get_all_scans()
    return render_template("dashboard.html", scans=scans)


@app.route("/scan", methods=["POST"])
def scan():
    url = request.form.get("url")

    if not url:
        flash("Please enter a URL to scan", "danger")
        return redirect(url_for("index"))

    if not (url.startswith("http://") or url.startswith("https://")):
        url = "http://" + url

    # Generate a unique scan ID
    scan_id = str(uuid.uuid4())
    scan_date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    # Add scan entry using SQLAlchemy
    add_scan(scan_id, url, scan_date)

    # Start the scan in a background thread
    scan_url(scan_id, url, scan_date)

    flash(f"Scan initiated for {url}. Scan ID: {scan_id}", "success")
    return redirect(url_for("index"))


@app.route("/scan_status/<scan_id>")
def scan_status(scan_id):
    scan_results = get_scan_results(scan_id)
    if scan_results:
        return jsonify({"status": scan_results.get("status", "unknown")})
    else:
        return jsonify({"status": "not_found"})


@app.route("/results/<scan_id>")
def results(scan_id):
    scan_results = get_scan_results(scan_id)
    pprint.pprint(scan_results)

    if scan_results:
        return render_template("report_template.html", results=scan_results)
    else:
        flash("Scan not found or still in progress", "warning")
        return redirect(url_for("index"))


@app.route("/generate_report/<scan_id>")
def generate_report(scan_id):
    scan_results = get_scan_results(scan_id)

    if not scan_results:
        flash("Scan not found or still in progress", "warning")
        return redirect(url_for("index"))

    # Generate PDF report
    report_path = generate_pdf_report(scan_id, scan_results)

    if report_path:
        # Update database with report path
        from scanner.scanner import save_scan_results
        save_scan_results(scan_id, report_path=report_path)

        flash("Report generated successfully", "success")

        # Extract filename from path
        filename = os.path.basename(report_path)
        return redirect(url_for("download_report", filename=filename))
    else:
        flash("Failed to generate report", "danger")
        return redirect(url_for("index"))


@app.route("/download_report/<filename>")
def download_report(filename):
    return send_from_directory("reports", filename, as_attachment=True)


@app.route("/delete_scan/<scan_id>", methods=["POST"])
def delete_scan(scan_id):
    # Get scan results first
    scan_results = get_scan_results(scan_id)
    report_path = scan_results.get("report_path") if scan_results else None

    # Remove report file
    if report_path and os.path.exists(report_path):
        os.remove(report_path)

    # Delete scan using SQLAlchemy
    from scanner.scanner import delete_scan
    delete_scan(scan_id)

    flash("Scan deleted successfully", "success")
    return redirect(url_for("index"))


if __name__ == "__main__":
    app.run(debug=True)
